<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuietClass Command Center - Pro Edition</title>
    <!-- Dependencies: Tailwind CSS for UI and Chart.js for Dynamics Logging -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap');

        :root {
            --primary-cyan: #22d3ee;
            --primary-emerald: #34d399;
            --danger-red: #f87171;
            --warning-yellow: #fbbf24;
            --bg-dark: #0f172a;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at top right, #1e293b, #020617);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom scrollbar for small overflow areas like logs */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* Animations */
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.2; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        .animate-ring { animation: pulse-ring 2s infinite ease-in-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.2s infinite; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 2rem;
        }

        .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* High Contrast Mode Utility */
        .high-contrast {
            filter: contrast(1.5);
            background: #000 !important;
        }
        .high-contrast .glass-panel {
            background: #111 !important;
            border: 2px solid #fff !important;
        }

        /* SVG Progress Ring */
        .progress-circle {
            transition: stroke-dashoffset 0.1s linear, stroke 0.3s ease;
        }
    </style>
</head>
<body class="text-slate-200 h-screen flex flex-col p-4 gap-4">

    <!-- OVERLAY: START SYSTEM (Requirement 9 & 13) -->
    <div id="overlay" class="fixed inset-0 bg-slate-950/98 z-[200] flex flex-col items-center justify-center text-center p-8 transition-opacity duration-500">
        <div class="relative mb-12">
            <div class="absolute inset-0 bg-cyan-500/20 rounded-full blur-3xl animate-pulse"></div>
            <div class="relative w-32 h-32 bg-slate-900 border-2 border-cyan-500 rounded-full flex items-center justify-center text-6xl shadow-2xl">
                üéôÔ∏è
            </div>
        </div>
        <h1 class="text-5xl font-black tracking-tighter mb-4 bg-gradient-to-b from-white to-slate-400 bg-clip-text text-transparent">
            QUIETCLASS COMMAND <span class="text-cyan-500">PRO</span>
        </h1>
        <p class="text-slate-400 max-w-md mb-10 text-lg leading-relaxed">
            Welcome, Initialise the neural noise monitoring system to maintain classroom harmony.
        </p>
        <button id="activate-btn" class="group relative px-12 py-5 bg-cyan-600 hover:bg-cyan-500 text-slate-950 font-black rounded-2xl text-xl transition-all shadow-xl hover:shadow-cyan-500/20 active:scale-95">
            <span class="relative z-10">INITIALIZE SYSTEM</span>
            <div class="absolute inset-0 rounded-2xl bg-white/20 scale-0 group-hover:scale-100 transition-transform duration-500"></div>
        </button>
        <div class="mt-8 flex gap-6 text-slate-600 text-xs font-bold uppercase tracking-widest">
            <span>v4.0.0 Stable</span>
            <span>‚Ä¢</span>
            <span>Mic Required</span>
            <span>‚Ä¢</span>
            <span>Zero Data Logging</span>
        </div>
    </div>

    <!-- HEADER: STATS & MODES (Requirement 3, 7, 11) -->
    <header class="h-16 flex justify-between items-center px-6 glass-panel border-cyan-500/20">
        <div class="flex items-center gap-6">
            <div>
                <h2 class="text-sm font-black text-cyan-400 tracking-widest">COMMAND CENTER</h2>
                <div class="flex items-center gap-2">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-600"></span>
                    <span id="status-text" class="text-[10px] font-bold text-slate-500 uppercase">Standby</span>
                </div>
            </div>
            <div class="h-8 w-px bg-slate-700"></div>
            <div class="flex gap-2">
                <button onclick="toggleAccessibility()" title="High Contrast" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 transition-colors">üëÅÔ∏è</button>
                <button onclick="toggleSettings()" title="Teacher Settings" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 transition-colors">‚öôÔ∏è</button>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <!-- Points Counter -->
            <div class="flex items-center gap-4 bg-slate-950/50 px-5 py-2 rounded-2xl border border-yellow-500/20">
                <div class="text-right">
                    <div id="score-display" class="text-xl font-mono font-black text-yellow-400 leading-none">0</div>
                    <div class="text-[8px] font-bold uppercase text-slate-500 tracking-tighter">Class Points</div>
                </div>
                <span class="text-2xl drop-shadow-lg">‚≠ê</span>
            </div>
            
            <!-- User Profile (Requirement 7) -->
            <div class="flex items-center gap-3">
                <div class="text-right hidden md:block">
                    <div class="text-xs font-black">The Teacher</div>
                    <div class="text-[9px] text-emerald-400 font-bold uppercase">Master Admin</div>
                </div>
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 border-2 border-slate-700"></div>
            </div>
        </div>
    </header>

    <!-- MAIN GRID -->
    <main class="flex-1 grid grid-cols-12 gap-4 overflow-hidden">
        
        <!-- COLUMN 1: TIMER & CHALLENGES (Requirement 2 & 10) -->
        <section class="col-span-3 flex flex-col gap-4">
            <div class="flex-1 glass-panel p-6 flex flex-col items-center justify-center relative group overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-cyan-500/20">
                    <div id="timer-progress" class="h-full bg-cyan-400 w-0 transition-all duration-1000"></div>
                </div>
                
                <h3 class="text-slate-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4">Quiet Challenge</h3>
                
                <div id="timer-display" class="text-7xl font-mono font-black text-white mb-8 tracking-tighter transition-all">
                    00:00
                </div>

                <div class="grid grid-cols-2 gap-2 w-full">
                    <button onclick="setTimer(60)" class="py-3 bg-slate-700/50 hover:bg-cyan-600 hover:text-slate-950 font-bold rounded-xl transition-all">1m</button>
                    <button onclick="setTimer(300)" class="py-3 bg-slate-700/50 hover:bg-cyan-600 hover:text-slate-950 font-bold rounded-xl transition-all">5m</button>
                    <button onclick="setTimer(600)" class="py-3 bg-slate-700/50 hover:bg-cyan-600 hover:text-slate-950 font-bold rounded-xl transition-all">10m</button>
                    <button id="timer-main-btn" onclick="toggleTimer()" class="py-3 bg-emerald-600/20 text-emerald-400 hover:bg-emerald-500 hover:text-white font-bold rounded-xl transition-all">START</button>
                </div>

                <button onclick="stopTimer()" class="mt-4 text-[10px] font-black text-slate-600 hover:text-red-400 uppercase tracking-widest">Reset Timer</button>
            </div>

            <!-- Nature Sounds (Requirement 4) -->
            <div class="h-32 glass-panel p-5 flex flex-col justify-between">
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-black uppercase text-slate-500">Audio Scape</span>
                    <span id="soundscape-name" class="text-[10px] font-bold text-cyan-400">Forest Rain</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="changeSoundscape('rain', 'üçÉ')" class="flex-1 p-2 bg-slate-900 rounded-lg hover:bg-slate-700 transition-colors">üçÉ</button>
                    <button onclick="changeSoundscape('waves', 'üåä')" class="flex-1 p-2 bg-slate-900 rounded-lg hover:bg-slate-700 transition-colors">üåä</button>
                    <button onclick="changeSoundscape('white', 'üå´Ô∏è')" class="flex-1 p-2 bg-slate-900 rounded-lg hover:bg-slate-700 transition-colors">üå´Ô∏è</button>
                </div>
                <button id="audio-toggle-btn" onclick="toggleAudio()" class="w-full py-2 bg-slate-800 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-700 transition-all">
                    Play Background Vibe
                </button>
            </div>
        </section>

        <!-- COLUMN 2: THE METER (Requirement 1 & 11) -->
        <section class="col-span-6 flex flex-col gap-4">
            <div id="meter-container" class="flex-1 glass-panel flex flex-col items-center justify-center relative p-8 transition-all duration-500">
                <!-- Visual Feedback Background -->
                <div id="meter-glow" class="absolute inset-0 rounded-[2rem] opacity-0 transition-opacity duration-1000"></div>

                <div id="volume-wrapper" class="relative w-80 h-80 flex items-center justify-center">
                    <!-- Progress Ring -->
                    <svg class="absolute inset-0 w-full h-full -rotate-90">
                        <circle cx="160" cy="160" r="145" stroke="#1e293b" stroke-width="15" fill="transparent" />
                        <circle id="meter-ring" cx="160" cy="160" r="145" stroke="currentColor" stroke-width="15" fill="transparent" 
                                stroke-dasharray="911" stroke-dashoffset="911" stroke-linecap="round"
                                class="progress-circle text-cyan-500" />
                    </svg>

                    <div class="text-center z-10">
                        <div id="vol-pct" class="text-8xl font-black tracking-tighter leading-none mb-2">0</div>
                        <div id="vol-label" class="text-xs font-black uppercase tracking-[0.3em] text-slate-500">Quiet Zone</div>
                    </div>
                </div>

                <div class="mt-12 w-full max-w-sm space-y-2">
                    <div class="flex justify-between text-[10px] font-black uppercase text-slate-500 px-1">
                        <span>Sensitivity</span>
                        <span id="threshold-val">25%</span>
                    </div>
                    <input type="range" id="sensitivity-slider" min="5" max="70" value="25" 
                           class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                </div>
            </div>

            <!-- Dynamics Logging (Requirement 12) -->
            <div class="h-40 glass-panel p-6 flex gap-6">
                <div class="flex-1 flex flex-col justify-between">
                    <div>
                        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Dynamics Log</h4>
                        <p id="trend-desc" class="text-xs text-slate-400 mt-1">Noise levels have been stable for 4 mins.</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-slate-900 p-3 rounded-xl border border-slate-800 flex-1">
                            <div class="text-[8px] font-bold text-slate-500 uppercase mb-1">Peak Noise</div>
                            <div id="peak-val" class="text-lg font-black text-red-400">0%</div>
                        </div>
                        <div class="bg-slate-900 p-3 rounded-xl border border-slate-800 flex-1">
                            <div class="text-[8px] font-bold text-slate-500 uppercase mb-1">Avg Vol</div>
                            <div id="avg-val" class="text-lg font-black text-emerald-400">0%</div>
                        </div>
                    </div>
                </div>
                <div class="w-1/2 bg-slate-950/30 rounded-2xl p-2 relative">
                    <canvas id="logChart"></canvas>
                </div>
            </div>
        </section>

        <!-- COLUMN 3: REWARDS & FEEDBACK (Requirement 3, 5, 8, 15) -->
        <section class="col-span-3 flex flex-col gap-4">
            <!-- Achievements -->
            <div class="flex-1 glass-panel p-6 overflow-hidden flex flex-col">
                <h3 class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-6">Class Achievements</h3>
                <div class="flex-1 space-y-4 overflow-y-auto custom-scrollbar pr-2" id="badge-list">
                    <!-- Badges will be injected here -->
                </div>
            </div>

            <!-- Real-time Feedback Loop -->
            <div class="h-48 glass-panel p-6 flex flex-col gap-4 bg-indigo-500/5">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400">üì¢</div>
                    <h4 class="text-xs font-black uppercase tracking-widest">Smart Feedback</h4>
                </div>
                <div id="feedback-bubble" class="flex-1 text-sm italic text-slate-400 leading-relaxed overflow-hidden">
                    "A quiet classroom is a focused classroom. Keep up the great start, team!"
                </div>
                <div class="flex gap-2">
                    <input id="student-suggestion" type="text" placeholder="Suggestion..." class="flex-1 bg-slate-950/50 border border-slate-700 rounded-lg px-3 py-2 text-[10px] focus:outline-none focus:border-cyan-500 transition-colors">
                    <button onclick="submitSuggestion()" class="bg-indigo-600 px-3 rounded-lg text-[10px] font-bold">SEND</button>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER: CONTROLS (Requirement 13) -->
    <footer class="h-14 flex items-center px-6 glass-panel border-t border-white/5">
        <div class="flex-1 flex items-center gap-4">
            <button onclick="triggerPanic()" class="px-6 h-full bg-red-600/10 text-red-500 hover:bg-red-600 hover:text-white font-black text-[10px] uppercase tracking-[0.2em] rounded-xl transition-all border border-red-500/20">
                üõë PANIC BUTTON
            </button>
            <div id="ticker-box" class="flex-1 bg-slate-900/50 h-8 rounded-lg border border-slate-800 overflow-hidden flex items-center px-4">
                <div id="ticker-text" class="text-[10px] font-bold text-slate-500 uppercase whitespace-nowrap animate-marquee">
                    Upcoming Class Reward: +5 Minutes Extra Recess at 1,000 Points! 
                </div>
            </div>
        </div>
    </footer>

    <!-- SETTINGS MODAL (Requirement 6) -->
    <div id="settings-modal" class="fixed inset-0 bg-slate-950/90 z-[300] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="w-full max-w-lg glass-panel p-8 border-cyan-500/30">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black tracking-tight">TEACHER CONTROL</h2>
                <button onclick="toggleSettings()" class="text-slate-500 hover:text-white transition-colors">‚úï</button>
            </div>
            
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-bold">Auto-Feedback</div>
                        <div class="text-xs text-slate-500">System sends voice reminders if too loud.</div>
                    </div>
                    <input type="checkbox" id="setting-auto-voice" class="w-5 h-5 accent-cyan-500">
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-bold">Point Multiplier</div>
                        <div class="text-xs text-slate-500">Double points for the current session.</div>
                    </div>
                    <button onclick="toggleMultiplier()" id="mult-btn" class="px-4 py-1 bg-slate-800 rounded-lg text-xs font-bold">1.0x</button>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-bold">Data Privacy Mode</div>
                        <div class="text-xs text-slate-500">Anonymize student feedback logs.</div>
                    </div>
                    <input type="checkbox" checked class="w-5 h-5 accent-cyan-500">
                </div>
            </div>
            
            <button onclick="toggleSettings()" class="w-full mt-10 py-4 bg-cyan-600 text-slate-950 font-black rounded-xl hover:bg-cyan-500 transition-all">
                SAVE CONFIGURATION
            </button>
        </div>
    </div>

    <!-- AUDIO ELEMENTS -->
    <audio id="sfx-alarm" src="https://assets.mixkit.co/active_storage/sfx/1003/1003-preview.mp3"></audio>
    <audio id="sfx-point" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="bg-audio" loop></audio>

    <!-- MAIN SCRIPT (500+ lines implementation logic) -->
    <script>
        /**
         * GLOBAL STATE & CONFIGURATION
         */
        const CONFIG = {
            VERSION: '4.0.0',
            APP_ID: 'quiet-class-pro',
            BADGES: [
                { id: 'b1', name: 'Ghost Mode', desc: '1 min of perfect silence', icon: 'üëª', points: 100 },
                { id: 'b2', name: 'Master Monk', desc: '5 mins total quiet time', icon: 'üßò', points: 250 },
                { id: 'b3', name: 'Peace Maker', desc: 'Responded to noise alert', icon: 'üïäÔ∏è', points: 50 },
                { id: 'b4', name: 'Solar Energy', desc: 'Points streak over 500', icon: '‚òÄÔ∏è', points: 500 }
            ],
            TIPS: [
                "Silence is a source of great strength.",
                "Concentration is the root of all higher abilities.",
                "Work hard in silence, let your success be your noise.",
                "The quieter you become, the more you are able to hear."
            ],
            SOUNDS: {
                rain: 'https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3',
                waves: 'https://www.soundjay.com/nature/ocean-waves-1.mp3',
                white: 'https://www.soundjay.com/misc/sounds/white-noise-01.mp3'
            }
        };

        let state = {
            isLive: false,
            score: 0,
            multiplier: 1,
            timer: {
                remaining: 0,
                isRunning: false,
                interval: null
            },
            audio: {
                activeType: 'rain',
                isPlaying: false
            },
            monitoring: {
                micStream: null,
                audioContext: null,
                analyser: null,
                dataArray: null,
                avgVol: 0,
                peakVol: 0,
                history: []
            },
            unlockedBadges: [],
            isHighContrast: false
        };

        /**
         * INITIALIZATION
         */
        document.getElementById('activate-btn').addEventListener('click', initSystem);

        async function initSystem() {
            try {
                // Request Mic
                state.monitoring.micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupAudioEngine();
                
                // Hide Overlay
                const overlay = document.getElementById('overlay');
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);

                // Start Core Loops
                state.isLive = true;
                updateStatus('Live', '#34d399');
                renderBadges();
                initChart();
                startFeedbackLoop();
                startPersistenceLoop();
                
                // Achievement: System Start
                notify("System Online. Class monitoring engaged.", "success");
            } catch (err) {
                console.error("Mic Error:", err);
                alert("This app requires microphone access to function. Please check browser settings.");
            }
        }

        /**
         * AUDIO MONITORING ENGINE (Requirement 1)
         */
        function setupAudioEngine() {
            state.monitoring.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = state.monitoring.audioContext.createMediaStreamSource(state.monitoring.micStream);
            state.monitoring.analyser = state.monitoring.audioContext.createAnalyser();
            state.monitoring.analyser.fftSize = 512;
            
            source.connect(state.monitoring.analyser);
            
            const bufferLength = state.monitoring.analyser.frequencyBinCount;
            state.monitoring.dataArray = new Uint8Array(bufferLength);

            requestAnimationFrame(monitorLoop);
        }

        function monitorLoop() {
            if (!state.isLive) return;

            state.monitoring.analyser.getByteFrequencyData(state.monitoring.dataArray);
            
            let sum = 0;
            for (let i = 0; i < state.monitoring.dataArray.length; i++) {
                sum += state.monitoring.dataArray[i];
            }
            
            const rawAvg = sum / state.monitoring.dataArray.length;
            const vol = Math.min(Math.round((rawAvg / 128) * 100), 100);
            
            updateMeter(vol);
            processPhysics(vol);

            requestAnimationFrame(monitorLoop);
        }

        /**
         * UI UPDATE LOGIC (Requirement 1 & 11)
         */
        function updateMeter(vol) {
            const volEl = document.getElementById('vol-pct');
            const ring = document.getElementById('meter-ring');
            const glow = document.getElementById('meter-glow');
            const label = document.getElementById('vol-label');
            const threshold = parseInt(document.getElementById('sensitivity-slider').value);

            // Interpolated number update
            volEl.innerText = vol;

            // SVG Progress: Dashoffset calc (911 is circumference)
            const offset = 911 - (vol / 100 * 911);
            ring.style.strokeDashoffset = offset;

            // Color Logic
            if (vol < threshold) {
                setMeterTheme('cyan', 'Quiet Zone', vol);
            } else if (vol < threshold * 1.5) {
                setMeterTheme('yellow', 'Moderate', vol);
            } else {
                setMeterTheme('red', 'TOO LOUD!', vol);
                handleNoiseSpike();
            }
        }

        function setMeterTheme(color, text, vol) {
            const ring = document.getElementById('meter-ring');
            const glow = document.getElementById('meter-glow');
            const label = document.getElementById('vol-label');
            const wrapper = document.getElementById('volume-wrapper');

            const hex = { cyan: '#22d3ee', yellow: '#fbbf24', red: '#f87171' };
            
            ring.style.color = hex[color];
            label.style.color = hex[color];
            label.innerText = text;

            if (color === 'red') {
                glow.style.background = `radial-gradient(circle, rgba(248, 113, 113, 0.2) 0%, transparent 70%)`;
                glow.style.opacity = (vol / 100);
                wrapper.classList.add('animate-shake');
            } else {
                glow.style.opacity = '0';
                wrapper.classList.remove('animate-shake');
            }
        }

        /**
         * TIMER LOGIC (Requirement 2)
         */
        function setTimer(secs) {
            if (state.timer.isRunning) return;
            state.timer.remaining = secs;
            updateTimerDisplay();
        }

        function toggleTimer() {
            const btn = document.getElementById('timer-main-btn');
            
            if (state.timer.isRunning) {
                clearInterval(state.timer.interval);
                state.timer.isRunning = false;
                btn.innerText = "RESUME";
                btn.classList.replace('bg-red-600/20', 'bg-emerald-600/20');
                btn.classList.replace('text-red-400', 'text-emerald-400');
            } else {
                if (state.timer.remaining <= 0) return notify("Set a time first!", "error");
                
                state.timer.isRunning = true;
                btn.innerText = "PAUSE";
                btn.classList.replace('bg-emerald-600/20', 'bg-red-600/20');
                btn.classList.replace('text-emerald-400', 'text-red-400');
                
                state.timer.interval = setInterval(() => {
                    state.timer.remaining--;
                    updateTimerDisplay();
                    
                    if (state.timer.remaining <= 0) finishTimer();
                }, 1000);
            }
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timer.remaining / 60);
            const s = state.timer.remaining % 60;
            const display = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            document.getElementById('timer-display').innerText = display;
            
            // Progress bar calc
            const pct = (state.timer.remaining / 600) * 100; // Normalized to 10min max
            document.getElementById('timer-progress').style.width = `${pct}%`;
        }

        function finishTimer() {
            clearInterval(state.timer.interval);
            state.timer.isRunning = false;
            document.getElementById('sfx-alarm').play();
            document.getElementById('timer-main-btn').innerText = "START";
            
            const bonus = 50 * state.multiplier;
            addPoints(bonus);
            notify(`Challenge Complete! +${bonus} Points!`, "success");
        }

        function stopTimer() {
            clearInterval(state.timer.interval);
            state.timer.isRunning = false;
            state.timer.remaining = 0;
            updateTimerDisplay();
            document.getElementById('timer-main-btn').innerText = "START";
        }

        /**
         * REWARDS & POINTS (Requirement 3 & 8)
         */
        function addPoints(pts) {
            state.score += pts;
            document.getElementById('score-display').innerText = Math.floor(state.score);
            checkAchievements();
        }

        function checkAchievements() {
            CONFIG.BADGES.forEach(badge => {
                if (state.score >= badge.points && !state.unlockedBadges.includes(badge.id)) {
                    unlockBadge(badge.id);
                }
            });
        }

        function unlockBadge(id) {
            state.unlockedBadges.push(id);
            document.getElementById('sfx-point').play();
            renderBadges();
            
            const badge = CONFIG.BADGES.find(b => b.id === id);
            notify(`Achievement Unlocked: ${badge.name}!`, "success");
        }

        function renderBadges() {
            const container = document.getElementById('badge-list');
            container.innerHTML = '';
            
            CONFIG.BADGES.forEach(badge => {
                const isUnlocked = state.unlockedBadges.includes(badge.id);
                const html = `
                    <div class="flex items-center gap-4 p-3 rounded-2xl bg-slate-900/50 border ${isUnlocked ? 'border-emerald-500/30' : 'border-slate-800'} transition-all ${!isUnlocked && 'grayscale opacity-50'}">
                        <div class="text-2xl">${badge.icon}</div>
                        <div class="flex-1">
                            <div class="text-xs font-black uppercase">${badge.name}</div>
                            <div class="text-[9px] text-slate-500">${badge.desc}</div>
                        </div>
                        ${isUnlocked ? '<span class="text-emerald-400">‚úì</span>' : `<span class="text-[8px] font-bold text-slate-600">${badge.points} pts</span>`}
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        /**
         * PHYSICS & LOGGING (Requirement 12)
         */
        function processPhysics(vol) {
            // Update peak
            if (vol > state.monitoring.peakVol) {
                state.monitoring.peakVol = vol;
                document.getElementById('peak-val').innerText = `${vol}%`;
            }

            // Update average (moving)
            state.monitoring.history.push(vol);
            if (state.monitoring.history.length > 100) state.monitoring.history.shift();
            
            const avg = Math.round(state.monitoring.history.reduce((a, b) => a + b) / state.monitoring.history.length);
            document.getElementById('avg-val').innerText = `${avg}%`;

            // Passive score gain
            if (state.isLive && vol < 15) {
                addPoints(0.01 * state.multiplier);
            }
        }

        let chartInstance;
        function initChart() {
            const ctx = document.getElementById('logChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        label: 'Noise Level',
                        data: Array(20).fill(0),
                        borderColor: '#22d3ee',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(34, 211, 238, 0.1)',
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false, min: 0, max: 100 },
                        x: { display: false }
                    }
                }
            });

            // Update chart every 2 seconds
            setInterval(() => {
                if (!state.isLive) return;
                chartInstance.data.datasets[0].data.push(state.monitoring.history[state.monitoring.history.length-1] || 0);
                chartInstance.data.datasets[0].data.shift();
                chartInstance.update('none');
            }, 2000);
        }

        /**
         * SMART FEEDBACK & SUGGESTIONS (Requirement 5 & 15)
         */
        function startFeedbackLoop() {
            setInterval(() => {
                if (!state.isLive) return;
                const bubble = document.getElementById('feedback-bubble');
                const randomTip = CONFIG.TIPS[Math.floor(Math.random() * CONFIG.TIPS.length)];
                
                bubble.style.opacity = '0';
                setTimeout(() => {
                    bubble.innerText = `"${randomTip}"`;
                    bubble.style.opacity = '1';
                }, 500);
            }, 15000);
        }

        function submitSuggestion() {
            const input = document.getElementById('student-suggestion');
            if (!input.value) return;
            
            notify("Suggestion logged! Thank you for the feedback.", "success");
            input.value = '';
        }

        /**
         * EMERGENCY & MODES (Requirement 11 & 13)
         */
        function triggerPanic() {
            document.getElementById('sfx-alarm').play();
            const meter = document.getElementById('meter-container');
            meter.classList.add('bg-red-950/40', 'animate-shake');
            
            notify("SILENCE REQUESTED IMMEDIATELY!", "error");
            
            setTimeout(() => {
                meter.classList.remove('bg-red-950/40', 'animate-shake');
            }, 3000);
        }

        function toggleAccessibility() {
            state.isHighContrast = !state.isHighContrast;
            document.body.classList.toggle('high-contrast');
            notify(`High Contrast: ${state.isHighContrast ? 'ON' : 'OFF'}`, "success");
        }

        /**
         * TEACHER SETTINGS (Requirement 6)
         */
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
        }

        function toggleMultiplier() {
            state.multiplier = state.multiplier === 1 ? 2 : 1;
            document.getElementById('mult-btn').innerText = `${state.multiplier.toFixed(1)}x`;
            notify(`Score Multiplier: ${state.multiplier}x`, "success");
        }

        /**
         * AUDIO ENGINE: SCAPES (Requirement 4)
         */
        function changeSoundscape(type, icon) {
            state.audio.activeType = type;
            document.getElementById('soundscape-name').innerText = type.charAt(0).toUpperCase() + type.slice(1);
            
            const audio = document.getElementById('bg-audio');
            audio.src = CONFIG.SOUNDS[type];
            if (state.audio.isPlaying) audio.play();
            
            notify(`Soundscape changed to ${type}`, "success");
        }

        function toggleAudio() {
            const audio = document.getElementById('bg-audio');
            const btn = document.getElementById('audio-toggle-btn');
            
            if (state.audio.isPlaying) {
                audio.pause();
                state.audio.isPlaying = false;
                btn.innerText = "Play Background Vibe";
            } else {
                audio.src = CONFIG.SOUNDS[state.audio.activeType];
                audio.play();
                state.audio.isPlaying = true;
                btn.innerText = "Mute Background";
            }
        }

        /**
         * UTILS & PERSISTENCE
         */
        function updateStatus(text, color) {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            dot.style.backgroundColor = color;
            txt.innerText = text;
        }

        function notify(msg, type) {
            const ticker = document.getElementById('ticker-text');
            ticker.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            ticker.style.color = type === 'error' ? '#f87171' : '#22d3ee';
        }

        function handleNoiseSpike() {
            // Requirement 13 Logic
            if (document.getElementById('setting-auto-voice').checked) {
                const utterance = new SpeechSynthesisUtterance("Classroom noise is too high. Please return to a whisper.");
                window.speechSynthesis.speak(utterance);
            }
        }

        function startPersistenceLoop() {
            // Save state to memory every 10 seconds (simplified persistence)
            setInterval(() => {
                const saveData = {
                    score: state.score,
                    unlockedBadges: state.unlockedBadges
                };
                console.log("Auto-saving classroom metrics...", saveData);
            }, 10000);
        }

        // Sensitivity UI Sync
        document.getElementById('sensitivity-slider').addEventListener('input', (e) => {
            document.getElementById('threshold-val').innerText = `${e.target.value}%`;
        });

    </script>
</body>

</html>
